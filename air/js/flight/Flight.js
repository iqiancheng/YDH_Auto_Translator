var Flight=function(n){this.query=n},FlightFactory;Flight.prototype.getId=function(){return"__"+CityMap.name2code[this.query.from]+"-"+CityMap.name2code[this.query.to]+"|"+this.query.date[0]+"-"+this.query.date[1]+"|"+this.query.extra[0]+"-"+this.query.extra[1]};Flight.prototype.getUrl=function(){if(this.url===undefined){var n=Math.min(this.query.date[0],this.query.extra[0]),t=Math.max(this.query.date[1],this.query.extra[1]);this.url="http://jipiao.kuxun.cn/tejia_v3/index.php?action=Liebao&method=Index&fromcity="+encodeURIComponent(this.query.from)+"&tocity="+encodeURIComponent(this.query.to)+"&fdate="+Util.date.format(n)+"&tdate="+Util.date.format(t)+config.urls.kuxunSuffix}return this.url};Flight.prototype.setData=function(n){return this.data=n,this};Flight.prototype.getData=function(n,t,i,r){var u={extra:[]},e,y,c,b=this.getUrl(),f=[],a,h,s,o=this,v,p,l;if(arguments[0]===undefined&&(n=0),n===!0&&(n=1),n||this.data===undefined)n||(n=1);else return this.data;if(arguments[1]===undefined&&(t=!1),v=function(n){if(o.simpleCheck(),n.status==1){e=n.data;for(key in e)(c=Util.date.parse(e[key].date),c<Math.min(o.query.date[0],o.query.extra[0])||c>Math.max(o.query.date[1],o.query.extra[1]))||((u.lowestPrice===undefined||parseInt(e[key].price,10)<u.lowestPrice)&&(u.lowestPrice=parseInt(e[key].price,10)),c>=o.query.date[0]&&c<=o.query.date[1]?u.main===undefined?u.main=e[key]:parseInt(e[key].price,10)<parseInt(u.main.price,10)?(f.push(u.main),u.main=e[key]):f.push(e[key]):f.push(e[key]))}if(u.main===undefined&&f.length===0)throw{name:"QueryResultError",message:"没有找到此条航线"};if(u.main===undefined)throw{name:"QuerySoldOutError",message:"对不起，机票刚刚卖光了"};for(a=Math.min(config.monitor.limit,f.length);a>0;a--){for(h in f){if(s===undefined){s=f[h];delete f[h];continue}parseInt(s.price,10)>parseInt(f[h].price,10)&&(f.push(s),s=f[h],delete f[h])}u.extra.push(s);s=undefined}return o.data=u,u},t)p=this.getUrl(),l=function(n){$.ajax({url:p,async:!0,error:function(){--n?l(n):r&&r({name:"RequestError",message:"连接失败"})},success:function(t){try{var u=v(JSON.parse(t));i&&i(u)}catch(f){--n?l(n):r&&r(f)}}})},l(n);else while(n)try{return y=JSON.parse($.ajax({url:this.getUrl(),async:!1}).responseText),v(y)}catch(w){if(!--n)throw w;}};Flight.prototype.simpleCheck=function(){if(CityMap.name2code[this.query.from]===undefined)throw{name:"QueryFromError",message:"对不起，不支持该出发地"};if(CityMap.name2code[this.query.to]===undefined)throw{name:"QueryToError",message:"对不起，不支持该目的地"};if(this.query.date[1]<Util.date.floor())throw{name:"QueryDateError",message:"对不起，这张机票你已经错过了"};if(this.query.date[0]>this.query.date[1])throw{name:"QueryDateError",message:"起始日期应小于结束日期"};};FlightFactory={getFromKeeper:function(){var n=InputKeeper.getInfo(),t={from:n.from,to:n.to,date:[n.dateFrom,n.dateTo],extra:[]},r=Math.max(n.date-1728e5,Util.date.floor()),i;return n.dateTo-n.dateFrom<864e5*(config.monitor.extraLeast-1)?(t.extra[0]=Math.max(Util.date.floor(),Util.date.floor(n.dateFrom+(n.dateTo-n.dateFrom)/2-432e5*(config.monitor.extraLeast-1))),t.extra[1]=t.extra[0]+864e5*(config.monitor.extraLeast-1)):t.extra=t.date,i=new Flight(t),n.data!==undefined&&i.setData(JSON.parse(n.data)),i},getFromId:function(n){var t=n.substring(2).split("|"),i=t[0].split("-"),r=t[1].split("-"),u=t[2].split("-");return new Flight({from:CityMap.code2name[i[0]],to:CityMap.code2name[i[1]],date:[parseInt(r[0],10),parseInt(r[1],10)],extra:[parseInt(u[0],10),parseInt(u[1],10)]})},getFromCtrip:function(n,t,i){var u=Util.date.parse(i),r=[];return r[0]=Math.min(u-1728e5,Util.date.floor()),r[1]=r[0]+3456e5,new Flight({from:CityMap.code2name[n],to:CityMap.code2name[t],date:[u,u],extra:r})}}